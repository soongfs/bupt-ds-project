<!-- <!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>åŒ—äº¬é‚®ç”µå¤§å­¦å¯¼èˆª - TravelMate</title>
    <script src="https://map.qq.com/api/gljs?v=1.exp&key=3HGBZ-SKRCT-UKNXT-V7KT6-T5LI2-XGF5F"></script>
    <link rel="stylesheet" href="./css/pages/navigation.css" />
  </head>
  <body>
    <div class="poi-container">
      <div id="map-container"></div>
      <div class="nav-panel">
        <div class="nav-header">
          <h1 class="nav-title">åŒ—äº¬é‚®ç”µå¤§å­¦å¯¼èˆª</h1>
          <p>è¯·è®¾ç½®æ‚¨çš„èµ·ç‚¹å’Œç»ˆç‚¹</p>
        </div>
        <div class="input-group">
          <label for="from">èµ·ç‚¹ä½ç½®</label>
          <input
            type="text"
            id="from"
            class="input-field"
            placeholder="è¯·è¾“å…¥èµ·ç‚¹åç§°"
            value="åŒ—äº¬é‚®ç”µå¤§å­¦ä¸œé—¨"
          />
        </div>
        <div class="input-group">
          <label for="to">ç»ˆç‚¹ä½ç½®</label>
          <input
            type="text"
            id="to"
            class="input-field"
            placeholder="è¯·è¾“å…¥ç»ˆç‚¹åç§°"
            value="åŒ—äº¬é‚®ç”µå¤§å­¦åŒ—é—¨"
          />
        </div>
        <button id="searchBtn" class="nav-button">å¼€å§‹å¯¼èˆª</button>
        <div class="route-info" id="routeInfo">
          <h3>æ¨èè·¯çº¿ä¿¡æ¯</h3>
          <p id="info-distance">ğŸ—ºï¸ æ€»è·ç¦»ï¼š--</p>
          <p id="info-time">â±ï¸ é¢„è®¡æ—¶é—´ï¼š--</p>
          <p id="info-via">ğŸš© é€”å¾„ï¼š--</p>
        </div>
      </div>
    </div>
    <script src="./js/navigation.js"></script>
  </body>
</html> -->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤šé€”å¾„ç‚¹è·¯å¾„è§„åˆ’</title>
  <script src="https://map.qq.com/api/gljs?v=1.exp&key=3HGBZ-SKRCT-UKNXT-V7KT6-T5LI2-XGF5F"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #map-container {
      flex: 1;
      width: 100%;
    }

    .control-panel {
      padding: 15px;
      background: #f5f5f5;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
    }

    .input-group {
      margin-bottom: 10px;
      display: flex;
      gap: 10px;
    }

    input {
      padding: 8px;
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    button {
      padding: 8px 15px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background: #45a049;
    }

    .info-panel {
      margin-top: 10px;
      padding: 10px;
      background: white;
      border-radius: 4px;
      font-size: 14px;
    }

    .waypoint-list {
      margin-top: 10px;
    }

    .waypoint-item {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }

    .waypoint-item input {
      flex: 1;
    }

    .remove-waypoint {
      margin-left: 10px;
      background: #f44336;
      padding: 5px 10px;
    }

    .add-waypoint {
      margin-top: 5px;
      background: #2196F3;
    }
  </style>
</head>

<body>
  <div id="map-container"></div>
  <div class="control-panel">
    <div class="input-group">
      <input type="text" id="from" placeholder="èµ·ç‚¹åç§°">
    </div>

    <div id="waypoints" class="waypoint-list">
      <!-- é€”å¾„ç‚¹å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
    </div>

    <button id="addWaypoint" class="add-waypoint">æ·»åŠ é€”å¾„ç‚¹</button>

    <div class="input-group">
      <input type="text" id="to" placeholder="ç»ˆç‚¹åç§°">
    </div>

    <button id="searchBtn">è®¡ç®—è·¯å¾„</button>

    <div class="info-panel">
      <div id="info-distance">ğŸ—ºï¸ æ€»è·ç¦»ï¼š--</div>
      <div id="info-time">â±ï¸ é¢„è®¡æ—¶é—´ï¼š--</div>
      <div id="info-via">ğŸš© é€”å¾„ï¼š--</div>
    </div>
  </div>

  <script>
    // åˆå§‹åŒ–åœ°å›¾
    const map = new TMap.Map(document.getElementById("map-container"), {
      center: new TMap.LatLng(39.96, 116.36),
      zoom: 16,
      pitch: 30,
      rotation: 0,
    });

    let currentPolyline = null;
    let markers = [];
    let waypointCounter = 0;

    // æ·»åŠ é€”å¾„ç‚¹è¾“å…¥æ¡†
    document.getElementById("addWaypoint").onclick = () => {
      const waypointsContainer = document.getElementById("waypoints");
      const waypointId = `waypoint-${waypointCounter++}`;

      const waypointItem = document.createElement("div");
      waypointItem.className = "waypoint-item";
      waypointItem.innerHTML = `
        <input type="text" id="${waypointId}" placeholder="é€”å¾„ç‚¹åç§°">
        <button class="remove-waypoint" data-id="${waypointId}">åˆ é™¤</button>
      `;

      waypointsContainer.appendChild(waypointItem);

      // æ·»åŠ åˆ é™¤äº‹ä»¶
      waypointItem.querySelector(".remove-waypoint").onclick = function () {
        waypointsContainer.removeChild(waypointItem);
      };
    };

    // è®¡ç®—è·¯å¾„
    document.getElementById("searchBtn").onclick = async () => {
      const fromName = document.getElementById("from").value.trim();
      const toName = document.getElementById("to").value.trim();

      if (!fromName || !toName) {
        alert("è¯·è‡³å°‘å¡«å†™èµ·ç‚¹å’Œç»ˆç‚¹åç§°");
        return;
      }

      // æ”¶é›†æ‰€æœ‰é€”å¾„ç‚¹
      const waypoints = [];
      const waypointInputs = document.querySelectorAll("#waypoints input");
      waypointInputs.forEach(input => {
        if (input.value.trim()) {
          waypoints.push(input.value.trim());
        }
      });

      // æ„é€ è¯·æ±‚å‚æ•°
      const params = new URLSearchParams();
      params.append("from", fromName);
      params.append("to", toName);
      waypoints.forEach(wp => params.append("waypoints", wp));

      // è¯·æ±‚åç«¯
      const res = await fetch(`/api/route?${params.toString()}`);
      const data = await res.json();

      if (!data.path || data.path.length === 0) {
        alert(data.error || "æœªæ‰¾åˆ°è·¯å¾„");
        return;
      }

      // æ„é€ åæ ‡
      const coords = data.path.map((p) => new TMap.LatLng(p.lat, p.lon));

      // æ¸…é™¤æ—§çš„çº¿è·¯ä¸æ ‡è®°
      if (currentPolyline) currentPolyline.setMap(null);
      markers.forEach(marker => marker.setMap(null));
      markers = [];

      // ç»˜åˆ¶è·¯å¾„
      currentPolyline = new TMap.MultiPolyline({
        map,
        styles: {
          routeStyle: new TMap.PolylineStyle({
            color: "#4CAF50",
            width: 6,
            borderWidth: 2,
            borderColor: "#FFFFFF",
          }),
        },
        geometries: [
          {
            id: "route",
            styleId: "routeStyle",
            paths: coords,
          },
        ],
      });

      // æ·»åŠ æ ‡è®°ï¼ˆèµ·ç‚¹ã€é€”å¾„ç‚¹ã€ç»ˆç‚¹ï¼‰
      const markerStyles = {
        start: new TMap.MarkerStyle({
          width: 34,
          height: 34,
          anchor: { x: 17, y: 34 },
          src: "https://mapapi.qq.com/web/lbs/javascriptGL/demo/img/markerDefault.png",
        }),
        waypoint: new TMap.MarkerStyle({
          width: 30,
          height: 30,
          anchor: { x: 15, y: 30 },
          src: "https://mapapi.qq.com/web/lbs/javascriptGL/demo/img/markerPurple.png",
        }),
        end: new TMap.MarkerStyle({
          width: 34,
          height: 34,
          anchor: { x: 17, y: 34 },
          src: "https://mapapi.qq.com/web/lbs/javascriptGL/demo/img/markerRed.png",
        }),
      };

      // èµ·ç‚¹æ ‡è®°
      markers.push(new TMap.MultiMarker({
        map,
        styles: { start: markerStyles.start },
        geometries: [{
          id: "start",
          position: coords[0],
          styleId: "start",
          properties: {
            title: "èµ·ç‚¹",
          }
        }],
      }));

      // é€”å¾„ç‚¹æ ‡è®°
      if (data.waypoints && data.waypoints.length > 0) {
        data.waypoints.forEach((wp, index) => {
          markers.push(new TMap.MultiMarker({
            map,
            styles: { waypoint: markerStyles.waypoint },
            geometries: [{
              id: `waypoint-${index}`,
              position: new TMap.LatLng(wp.lat, wp.lon),
              styleId: "waypoint",
              properties: {
                title: `é€”å¾„ç‚¹ ${index + 1}`,
              }
            }],
          }));
        });
      }

      // ç»ˆç‚¹æ ‡è®°
      markers.push(new TMap.MultiMarker({
        map,
        styles: { end: markerStyles.end },
        geometries: [{
          id: "end",
          position: coords[coords.length - 1],
          styleId: "end",
          properties: {
            title: "ç»ˆç‚¹",
          }
        }],
      }));

      // è°ƒæ•´è§†é‡åˆ°æ•´ä¸ªè·¯å¾„
      const bounds = coords.reduce(
        (b, pt) => b.extend(pt),
        new TMap.LatLngBounds()
      );
      map.fitBounds(bounds, { padding: 20 });

      // æ›´æ–°è·¯çº¿ä¿¡æ¯
      const totalDist = data.path.slice(1).reduce((sum, p, i) => {
        const prev = data.path[i];
        const dx = prev.lat - p.lat;
        const dy = prev.lon - p.lon;
        return sum + Math.sqrt(dx * dx + dy * dy) * 111000; // ç²—ç•¥æ¢ç®—ç±³
      }, 0);

      document.getElementById("info-distance").innerText = `ğŸ—ºï¸ æ€»è·ç¦»ï¼š${(
        totalDist / 1000
      ).toFixed(2)} å…¬é‡Œ`;

      document.getElementById(
        "info-time"
      ).innerText = `â±ï¸ é¢„è®¡æ—¶é—´ï¼šæ­¥è¡Œ ${Math.ceil((totalDist / 1000) * 12)} åˆ†é’Ÿ`; // å‡è®¾ 5km/h = 12min/km

      // æ˜¾ç¤ºé€”å¾„ç‚¹ä¿¡æ¯
      let viaText = "ğŸš© é€”å¾„ï¼š";
      if (data.waypoints && data.waypoints.length > 0) {
        viaText += data.waypoints.map((wp, index) =>
          `é€”å¾„ç‚¹ ${index + 1} (${wp.node_id})`
        ).join(" â†’ ");
      } else {
        viaText += "æ— é€”å¾„ç‚¹";
      }
      document.getElementById("info-via").innerText = viaText;
    };
  </script>
</body>

</html>