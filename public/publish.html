<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>发布新日记 - TravelMate</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <!-- 引入 wangEditor 样式 -->
    <link href="https://unpkg.com/@wangeditor/editor@latest/dist/css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary: #2a9d8f;
            --secondary: #264653;
            --border: #e0e0e0;
            --bg: #f8f9fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Segoe UI", "PingFang SC", sans-serif;
        }

        body {
            background: var(--bg);
        }

        .editor-container {
            max-width: 800px;
            margin: 2rem auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }

        /* 标题区域 */
        .title-section {
            margin-bottom: 2rem;
        }

        .title-input {
            width: 100%;
            font-size: 2rem;
            border: none;
            padding: 1rem;
            font-weight: 600;
            color: var(--secondary);
        }

        .title-input::placeholder {
            color: #999;
        }

        /* 工具栏 - 修改为适应 wangEditor 的样式 */
        .toolbar {
            border: 1px solid var(--border);
            border-bottom: none;
            padding: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.2rem;
        }

        .tool-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: var(--bg);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* 编辑区域 - 修改为适应 wangEditor 的样式 */
        .editor-wrapper {
            border: 1px solid var(--border);
            border-radius: 0 0 4px 4px;
            margin-bottom: 2rem;
        }

        .editor-content {
            min-height: 400px;
            padding: 1rem;
            overflow-y: auto;
        }

        /* 附加功能 */
        .upload-section {
            margin-bottom: 2rem;
        }

        .upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem 1.5rem;
            background: var(--bg);
            border: 1px dashed var(--border);
            border-radius: 4px;
            cursor: pointer;
        }

        .upload-btn:hover {
            border-color: var(--primary);
        }

        /* 设置区域 */
        .settings-section {
            border-top: 1px solid var(--border);
            padding-top: 2rem;
        }

        .setting-item {
            margin-bottom: 1.5rem;
        }

        .setting-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .tag-input {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            width: 300px;
        }

        .tag-hint {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        /* 发布按钮 */
        .publish-btns {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--secondary);
            /* ★ 保持垂直 padding 与 .upload-btn 一致 (0.8rem) */
            /* ★ 水平 padding 可以不同 (这里是 2rem, upload-btn 是 1.5rem，这没关系) */
            padding: 0.8rem 2rem;
            border: 1px solid var(--border);
            /* 边框样式可以不同 */
            border-radius: 4px;
            cursor: pointer;

            /* --- ★★★ 添加以下属性以匹配 .upload-btn 的布局和对齐方式 ★★★ --- */
            display: inline-flex;
            /* 使用 inline-flex 布局 */
            align-items: center;
            /* 垂直居中按钮内部的内容 (图标和文字) */
            justify-content: center;
            /* 可选：水平居中内容 */
            gap: 0.5rem;
            /* ★ 匹配 .upload-btn 的内部间距 (图标和文字之间) */
            vertical-align: middle;
            /* ★ 尝试添加这个，有助于按钮自身与其他行内元素的对齐 */
            /* 确保没有设置与 .upload-btn 冲突的 height 或 line-height */
            /* box-sizing: border-box; 已经在 * 选择器中全局设置，无需重复 */
        }

        .sections-container,
        .media-container {
            margin-bottom: 2rem;
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
        }

        .section-item,
        .media-item {
            background: var(--bg);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
        }

        .section-header,
        .media-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .section-title,
        .media-caption {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        .remove-btn {
            color: #ff6b6b;
            background: none;
            border: none;
            cursor: pointer;
        }

        .media-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 0.5rem;
        }

        .sections-container {
            margin-bottom: 2rem;
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
        }

        .sections-container h3 {
            color: var(--secondary);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sections-container h3::before {
            content: "";
            display: inline-block;
            width: 4px;
            height: 1.2rem;
            background: var(--primary);
            border-radius: 2px;
        }

        #sections-list {
            margin-bottom: 1rem;
        }

        .section-item {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
        }

        .section-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px dashed var(--border);
        }

        .section-header h4 {
            color: var(--primary);
            font-size: 1.1rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-header h4::before {
            content: "✈";
            font-size: 0.9rem;
        }

        .section-title {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s;
        }

        .section-title:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(42, 157, 143, 0.2);
        }

        .section-content {
            width: 100%;
            min-height: 120px;
            padding: 0.8rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.95rem;
            line-height: 1.6;
            resize: vertical;
            transition: all 0.3s;
        }

        .section-content:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(42, 157, 143, 0.2);
        }

        .remove-btn {
            color: #ff6b6b;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 0.3rem;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .remove-btn:hover {
            background: rgba(255, 107, 107, 0.1);
            transform: scale(1.1);
        }

        #add-section-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem 1.5rem;
            background: white;
            border: 1px dashed var(--primary);
            color: var(--primary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        #add-section-btn:hover {
            background: rgba(42, 157, 143, 0.1);
            border-style: solid;
        }

        .day-number-badge {
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }

        /* 智能助手窗口样式 */
        .chat-container {
            position: fixed;
            right: 20px;
            bottom: 20px;
            max-width: 400px;
            width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: #2a9d8f;
            color: white;
            padding: 10px 15px;
            font-size: 1rem;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .chat-body {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            min-height: 200px;
            max-height: 300px;
        }

        .message {
            margin: 8px 0;
            padding: 10px;
            border-radius: 6px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .user {
            background: #d1e7dd;
            align-self: flex-end;
        }

        .bot {
            background: #f8f9fa;
            align-self: flex-start;
            border-left: 4px solid #2a9d8f;
        }

        .chat-footer {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
        }

        .chat-input {
            flex-grow: 1;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .chat-send-btn {
            margin-left: 10px;
            padding: 8px 16px;
            background: #2a9d8f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .chat-send-btn:hover {
            background: #0056b3;
        }

        .insert-btn {
            margin-left: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 4px;
        }

        .insert-btn:hover {
            background-color: #45a049;
        }

        /* --- ★★★ 聊天框相关CSS调整 ★★★ --- */
        .chat-container {
            position: fixed;
            right: 20px;
            bottom: 20px;
            max-width: 400px;
            /* 您可以根据需要调整聊天框最大宽度 */
            width: 90%;
            /* 在小屏幕上占宽度百分比 */
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            /* ★★★ 新增：给聊天框一个最大高度，并允许内部滚动 ★★★ */
            max-height: 70vh;
            /* 例如，最大高度为视窗高度的70% */
        }

        .chat-header {
            background: var(--primary);
            /* 使用CSS变量 */
            color: white;
            padding: 10px 15px;
            font-size: 1rem;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            flex-shrink: 0;
            /* 防止头部被压缩 */
        }

        .chat-body {
            flex-grow: 1;
            /* 占据剩余空间 */
            padding: 10px;
            overflow-y: auto;
            /* ★★★ 聊天内容区域滚动 ★★★ */
            min-height: 150px;
            /* 给聊天内容一个最小高度 */
        }

        /* ★★★ 图片预览区域CSS调整 ★★★ */
        #chatImagePreviewContainer {
            padding: 5px 10px;
            /* 上下左右都留一些边距 */
            background-color: #f9f9f9;
            /* 给预览区一个浅色背景以区分 */
            border-top: 1px solid #eee;
            /* 与聊天输入区有分隔 */
            border-bottom: 1px solid #eee;
            /* 与聊天输入区有分隔 */
            max-height: 85px;
            /* ★★★ 限制预览区域本身的高度 ★★★ */
            overflow-x: auto;
            /* ★★★ 如果图片横向排列超出，则允许横向滚动 ★★★ */
            overflow-y: hidden;
            /* 禁止垂直滚动，依赖整体聊天框滚动 */
            display: flex;
            /* 使用flex布局让图片横向排列 */
            align-items: center;
            /* 垂直居中图片（如果图片高度不一） */
            flex-shrink: 0;
            /* 防止预览区被压缩 */
            white-space: nowrap;
            /* 防止图片被强制换行，配合overflow-x: auto */
        }

        #chatImagePreviewContainer .preview-item {
            display: inline-flex;
            align-items: flex-start;
            margin-right: 8px;
            /* 图片之间的间距 */
            position: relative;
            border: 1px solid #ddd;
            padding: 2px;
            background-color: white;
            border-radius: 4px;
        }

        #chatImagePreviewContainer img.chat-preview-image {
            /* ★★★ 严格控制预览图的尺寸 ★★★ */
            width: 60px;
            /* 固定宽度 */
            height: 60px;
            /* 固定高度 */
            object-fit: cover;
            /* 保持图片比例，多余部分裁剪 */
            border-radius: 3px;
            /* 轻微圆角 */
            display: block;
            /* 避免图片下方有额外空隙 */
        }

        #chatImagePreviewContainer .remove-preview-btn {
            font-size: 12px;
            /* 调小关闭按钮 */
            line-height: 1;
            color: white;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            cursor: pointer;
            position: absolute;
            top: -6px;
            /* 调整位置使其在图片边框外一点 */
            right: -6px;
            /* 调整位置 */
            border: 1px solid white;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
        }

        #chatImagePreviewContainer .remove-preview-btn:hover {
            background-color: rgba(255, 0, 0, 0.8);
        }


        .chat-footer {
            display: flex;
            align-items: center;
            padding: 10px;
            border-top: 1px solid #ddd;
            /* 如果预览区有下边框，这里可以考虑去掉或调整 */
            flex-shrink: 0;
            /* 防止脚部被压缩 */
        }

        .chat-upload-btn {
            padding: 0;
            /* 移除内边距，让图标撑开 */
            margin-right: 8px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f0f0f0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            /* 固定宽度 */
            height: 36px;
            /* 固定高度，与输入框和发送按钮协调 */
            box-sizing: border-box;
        }

        .chat-upload-btn:hover {
            background-color: #e0e0e0;
        }

        .chat-upload-btn i {
            color: #555;
            font-size: 1.1em;
            /* 稍微调大图标 */
        }

        .chat-input {
            flex-grow: 1;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            height: 36px;
            box-sizing: border-box;
            font-size: 0.9rem;
        }

        .chat-send-btn {
            margin-left: 8px;
            /* 与输入框的间距 */
            padding: 0 15px;
            /* 调整内边距 */
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            height: 36px;
            box-sizing: border-box;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .chat-send-btn:hover {
            background: #268074;
        }
    </style>
</head>

<body>
    
    <div class="editor-container">
        <!-- 修改为表单形式 -->
        <form id="diaryForm">
            <!-- 标题 -->
            <div class="title-section">
                <input type="text" class="title-input" id="title" name="title" placeholder="请输入日记标题（最多50字）"
                    maxlength="50" required />
            </div>

            <!-- wangEditor 容器 -->
            <div id="editor-container">
                <!-- 工具栏 -->
                <div class="toolbar" id="toolbar-container"></div>
                <!-- 编辑区 -->
                <div class="editor-wrapper">
                    <div class="editor-content" id="editor-content"></div>
                </div>
            </div>

            <!-- 图片上传 -->
            <div class="upload-section">
                <label class="upload-btn">
                    <i class="fas fa-cloud-upload-alt"></i>
                    上传封面图片
                    <input type="file" id="coverImage" name="coverImage" hidden accept="image/*" />
                </label>
                <button type="  button" id="polishTextBtn" class="btn-secondary" style="
                                margin-left: 408px;
                                background-color: #2a9d8f;
                                color: white;              /* 白色字体 */
                                font-family: 'Arial', sans-serif; /* 字体 */
                                font-size: 15px;           /* 字号 */
                                font-weight: bold;         /* 加粗 */
                            ">
                    <i class="fas fa-magic"></i>
                    一键润色
                </button>
                <div id="imagePreview" style="margin-top: 10px;"></div>
            </div>

            <!-- 在编辑器后面添加以下内容 -->
            <div class="sections-container">
                <h3>行程分段</h3>
                <div id="sections-list">
                    <!-- 分段将被动态添加到这里 -->
                </div>
                <button type="button" id="add-section-btn" class="btn-secondary">
                    <i class="fas fa-plus"></i> 添加新的一天
                </button>
            </div>

            <div class="media-container">
                <h3>媒体管理</h3>
                <div id="media-list">
                    <!-- 媒体项将被动态添加到这里 -->
                </div>
                <div class="media-upload">
                    <label class="upload-btn">
                        <i class="fas fa-cloud-upload-alt"></i>
                        上传图片/视频
                        <input type="file" id="mediaUpload" name="media" hidden multiple accept="image/*,video/*" />
                    </label>
                    <div class="media-hint">可以上传多张图片或视频</div>
                </div>
            </div>

            <!-- 设置区域 -->
            <div class="settings-section">
                <div class="setting-item">
                    <label class="setting-label">添加标签（最多5个）</label>
                    <input type="text" class="tag-input" id="tags" name="tags" placeholder="输入标签，用逗号分隔" />
                    <div class="tag-hint">例如：西藏旅行, 自驾游, 摄影攻略</div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">发布设置</label>
                    <div style="display: flex; gap: 2rem">
                        <label> <input type="checkbox" name="allowComments" checked /> 允许评论 </label>
                        <label> <input type="checkbox" name="syncToProfile" checked /> 同步到个人主页 </label>
                        <label> <input type="checkbox" name="fansOnly" /> 仅粉丝可见 </label>
                    </div>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="publish-btns">
                <button type="button" class="btn-primary" id="publishBtn">立即发布</button>
                <button type="button" class="btn-secondary" id="saveDraftBtn">保存草稿</button>
            </div>
        </form>
    </div>

    <!-- ★★★ 聊天窗口HTML，包含新的上传按钮和预览区域 ★★★ -->
    <div class="chat-container">
        <div class="chat-header">TravelMate 旅游日记助手</div>
        <div class="chat-body" id="chatBox"></div>
        <!-- 图片预览区域现在移到 chat-footer 下面，紧邻输入区域 -->
        <div id="chatImagePreviewContainer">
            <!-- {/* 预览会显示在这里 */} -->
        </div>
        <div class="chat-footer">
            <label for="chatImageUpload" class="chat-upload-btn" title="上传图片">
                <i class="fas fa-paperclip"></i>
            </label>
            <input type="file" id="chatImageUpload" accept="image/*" style="display: none;">

            <input type="text" id="userInput" class="chat-input" placeholder="输入消息..." />
            <button class="chat-send-btn" onclick="sendMessageWithOptionalImage()">发送</button>
        </div>
    </div>

    <!-- 引入 wangEditor -->
    <script src="https://unpkg.com/@wangeditor/editor@latest/dist/index.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const publishBtn = document.getElementById('publishBtn');
            const saveDraftBtn = document.getElementById('saveDraftBtn');
            const coverImageInput = document.getElementById('coverImage');
            const imagePreview = document.getElementById('imagePreview');

            // 初始化 wangEditor
            const { createEditor, createToolbar } = window.wangEditor;

            const editorConfig = {
                placeholder: '从这里开始书写你的旅行故事...',
                onChange(editor) {
                    // 可以在这里处理内容变化
                },
                MENU_CONF: {
                    uploadImage: {
                        server: '/api/upload-image',
                        fieldName: 'image',
                        maxFileSize: 10 * 1024 * 1024, // 10M
                        allowedFileTypes: ['image/*'],
                        customInsert(res, insertFn) {
                            if (res.success) {
                                insertFn(res.data.url, '', '');
                            } else {
                                alert('图片上传失败: ' + res.message);
                            }
                        },
                        onError(file, err, res) {
                            alert('图片上传出错: ' + (err.message || '未知错误'));
                        }
                    },
                    uploadVideo: {
                        server: '/api/upload-video',
                        fieldName: 'video',
                        maxFileSize: 50 * 1024 * 1024, // 50M
                        allowedFileTypes: ['video/*'],
                        customInsert(res, insertFn) {
                            if (res.success) {
                                insertFn(res.data.url, '');
                            } else {
                                alert('视频上传失败: ' + res.message);
                            }
                        }
                    }
                }
            };

            const editor = createEditor({
                selector: '#editor-content',
                config: editorConfig,
                mode: 'default',
            });

            window.editor = editor;

            // 添加 input 事件监听器
            editor.on('input', () => {
                const currentHtml = editor.getHtml().trim();
                const defaultContent = '<p>从这里开始书写你的旅行故事...</p>';

                if (currentHtml === defaultContent) {
                    editor.setHtml('<p></p>');
                }
            });

            const toolbar = createToolbar({
                editor,
                selector: '#toolbar-container',
                config: {
                    excludeKeys: [
                        'group-video',
                        'fullScreen'
                    ]
                },
                mode: 'default'
            });

            // 图片预览功能
            coverImageInput.addEventListener('change', function (e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    const reader = new FileReader();

                    reader.onload = function (event) {
                        imagePreview.innerHTML = `
                        <img src="${event.target.result}" style="max-width: 200px; max-height: 200px;" />
                        <p>${file.name}</p>
                    `;
                    };

                    reader.readAsDataURL(file);
                }
            });

            // 发布日记
            publishBtn.addEventListener('click', function () {
                submitDiary(2); // 2表示已发布
            });

            // 保存草稿
            saveDraftBtn.addEventListener('click', function () {
                submitDiary(1); // 1表示草稿
            });

            // 行程分段管理
            const sectionsList = document.getElementById('sections-list');
            const addSectionBtn = document.getElementById('add-section-btn');
            let sectionCounter = 1;

            function addSection(dayNumber = null, title = '', content = '') {
                const dayNum = dayNumber || sectionCounter;
                const sectionId = `section-${Date.now()}`;

                const sectionHTML = `
                <div class="section-item" id="${sectionId}" data-day="${dayNum}">
                    <div class="section-header">
                        <h4><span class="day-number-badge">${dayNum}</span> 第 ${dayNum} 天</h4>
                        <button type="button" class="remove-btn" onclick="removeSection('${sectionId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <input type="text" class="section-title" placeholder="这一天的主要行程或地点" value="${title}" />
                    <textarea class="section-content" placeholder="详细描述这一天的经历...">${content}</textarea>
                </div>
            `;

                sectionsList.insertAdjacentHTML('beforeend', sectionHTML);
                if (!dayNumber) sectionCounter++;
            }

            addSectionBtn.addEventListener('click', () => addSection());

            // 媒体管理
            const mediaList = document.getElementById('media-list');
            const mediaUpload = document.getElementById('mediaUpload');
            let mediaCounter = 1;

            function addMediaItem(file, url = null, caption = '', type = null) {
                const mediaId = `media-${Date.now()}`;
                const mediaType = type || (file.type.startsWith('video') ? 'video' : 'image');
                const mediaUrl = url || URL.createObjectURL(file);

                const mediaHTML = `
                <div class="media-item" id="${mediaId}" data-type="${mediaType}">
                    <div class="media-header">
                        <span>媒体 #${mediaCounter++}</span>
                        <button type="button" class="remove-btn" onclick="removeMedia('${mediaId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <input type="text" class="media-caption" placeholder="媒体描述" value="${caption}" />
                    <div class="media-preview-container">
                        ${mediaType === 'image' ?
                        `<img src="${mediaUrl}" class="media-preview" />` :
                        `<video controls src="${mediaUrl}" class="media-preview"></video>`}
                    </div>
                    <input type="hidden" name="media_url" value="${mediaUrl}" />
                    <input type="hidden" name="media_type" value="${mediaType}" />
                </div>
            `;

                mediaList.insertAdjacentHTML('beforeend', mediaHTML);
            }

            mediaUpload.addEventListener('change', function (e) {
                Array.from(e.target.files).forEach(file => {
                    addMediaItem(file);
                });
                e.target.value = '';
            });

            // 全局函数供按钮使用
            window.removeSection = function (id) {
                document.getElementById(id)?.remove();
            };

            window.removeMedia = function (id) {
                document.getElementById(id)?.remove();
            };

            // 提交日记函数
            function submitDiary(status) {
                const title = document.getElementById('title').value;
                const content = editor.getHtml();
                const tags = document.getElementById('tags').value;
                const allowComments = document.querySelector('input[name="allowComments"]').checked;
                const syncToProfile = document.querySelector('input[name="syncToProfile"]').checked;
                const fansOnly = document.querySelector('input[name="fansOnly"]').checked;

                // 收集分段数据
                const sections = Array.from(document.querySelectorAll('.section-item')).map(section => ({
                    dayNumber: parseInt(section.dataset.day),
                    title: section.querySelector('.section-title').value,
                    content: section.querySelector('.section-content').value,
                    order: parseInt(section.dataset.day)
                }));

                // 收集媒体数据
                const mediaItems = Array.from(document.querySelectorAll('.media-item')).map(media => ({
                    url: media.querySelector('input[name="media_url"]').value,
                    type: media.dataset.type,
                    caption: media.querySelector('.media-caption').value,
                    order: Array.from(document.querySelectorAll('.media-item')).indexOf(media) + 1
                }));

                // 表单验证
                if (!title.trim()) {
                    alert('请输入日记标题');
                    return;
                }

                if (!content.trim() || content === '<p>从这里开始书写你的旅行故事...</p>') {
                    alert('请输入日记内容');
                    return;
                }

                const formData = new FormData();
                formData.append('title', title);
                formData.append('content', content);
                formData.append('tags', tags);
                formData.append('allowComments', allowComments);
                formData.append('syncToProfile', syncToProfile);
                formData.append('fansOnly', fansOnly);
                formData.append('status', status);
                formData.append('sections', JSON.stringify(sections));
                formData.append('mediaItems', JSON.stringify(mediaItems));

                if (coverImageInput.files.length > 0) {
                    formData.append('coverImage', coverImageInput.files[0]);
                }

                Array.from(mediaUpload.files).forEach((file, index) => {
                    formData.append(`mediaFiles_${index}`, file);
                });

                fetch('/api/diaries', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(status === 2 ? '日记发布成功！' : '草稿保存成功！');
                            window.location.href = '/user/diaries';
                        } else {
                            throw new Error(data.message || '操作失败');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('发生错误: ' + error.message);
                    });
            }
        });
    </script>
    <script>
        // 全局常量和变量
        const COZE_API_BASE_URL = 'https://api.coze.cn';
        const COZE_ACCESS_TOKEN = 'pat_QRPpeZbkbheuqvhgIwvTXmNhzuR5Z3qZCOd1ZOU3wzF9MO3EMLzL29qdiQH5Juqw';
        const COZE_BOT_ID = '7500528781573537802';
        const COZE_USER_ID = 'travelmate_user_123';

        const API_URL_CREATE_CONVERSATION = `${COZE_API_BASE_URL}/v1/conversation/create`;
        const API_URL_CHAT_BASE = `${COZE_API_BASE_URL}/v3/chat`;
        const API_URL_FILE_UPLOAD = `${COZE_API_BASE_URL}/v1/files/upload`;
        const API_URL_RETRIEVE_CHAT_DETAILS = `${COZE_API_BASE_URL}/v3/chat/retrieve`;
        const API_URL_LIST_CONVERSATION_MESSAGES = `${COZE_API_BASE_URL}/v1/conversation/message/list`;

        let currentCozeConversationId = null;
        let selectedChatImageFile = null;

        // DOM 操作函数
        function addMessage(text, type) {
            const chatBox = document.getElementById('chatBox');
            if (!chatBox) { console.error("addMessage: chatBox not found"); return null; }
            const msg = document.createElement('div');
            msg.className = `message ${type === 'bot-opening' ? 'bot' : type}`;
            const span = document.createElement('span');
            span.className = (type === 'user') ? 'user-message' : 'bot-message';
            if (type === 'user') {
                span.textContent = text;
            } else {
                span.innerHTML = text;
            }
            msg.appendChild(span);
            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;
            return msg;
        }

        function updateMessage(element, newText, isFinal = false) {
            if (!element) { console.error("updateMessage: element is null"); return; }
            let contentSpan = element.querySelector('.bot-message');
            if (!contentSpan) {
                console.warn("updateMessage: .bot-message span not found. Creating one or updating element directly.");
                if (element.classList.contains('message')) {
                    element.innerHTML = '';
                    const newSpan = document.createElement('span');
                    newSpan.className = 'bot-message';
                    element.appendChild(newSpan);
                    contentSpan = newSpan;
                } else {
                    contentSpan = element;
                }
            }

            let displayText = newText;
            if (typeof displayText === 'string') {
                if (element.classList.contains('bot-opening')) {
                    displayText = displayText.replace(/\n/g, '<br>');
                } else if (typeof marked === 'function') {
                    displayText = marked.parse(displayText);
                } else {
                    displayText = displayText.replace(/\n/g, '<br>');
                }
            } else if (displayText === null || typeof displayText === 'undefined') {
                displayText = '';
            }
            contentSpan.innerHTML = displayText;

            const existingInsertBtn = element.querySelector('.insert-btn');
            if (isFinal) {
                if (!existingInsertBtn && newText &&
                    !String(newText).toLowerCase().includes("正在") &&
                    !String(newText).toLowerCase().includes("获取") &&
                    !String(newText).toLowerCase().includes("出错") &&
                    !String(newText).toLowerCase().includes("失败") &&
                    !String(newText).toLowerCase().includes("超时") &&
                    !String(newText).toLowerCase().includes("未找到")
                ) {
                    const insertBtn = document.createElement('button');
                    insertBtn.className = 'insert-btn';
                    insertBtn.textContent = '插入到编辑器';
                    element.appendChild(insertBtn);
                }
            } else {
                if (existingInsertBtn) existingInsertBtn.remove();
            }
            const chatBox = document.getElementById('chatBox');
            if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
        }

        function simulateTypingEffect(messageElement, fullText, showButtonAtEnd = false) {
            if (!messageElement) {
                console.error("simulateTypingEffect: messageElement is null");
                return;
            }
            let contentSpan = messageElement.querySelector('.bot-message');
            if (!contentSpan) {
                console.error("simulateTypingEffect: .bot-message span not found. Creating one.");
                if (messageElement.classList.contains('message')) {
                    messageElement.innerHTML = '<span class="bot-message"></span>';
                    contentSpan = messageElement.querySelector('.bot-message');
                } else {
                    console.error("Cannot create .bot-message span in non-message element for typing effect.");
                    return;
                }
            }

            let index = 0;
            const speed = 50;
            let currentTextForTyping = "";
            contentSpan.innerHTML = "";

            function type() {
                if (index < fullText.length) {
                    const char = fullText.charAt(index);
                    if (char === '\n') {
                        currentTextForTyping += '<br>';
                    } else {
                        currentTextForTyping += char;
                    }
                    contentSpan.innerHTML = currentTextForTyping;
                    index++;
                    const chatBox = document.getElementById('chatBox');
                    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
                    setTimeout(type, speed);
                } else {
                    updateMessage(messageElement, fullText, showButtonAtEnd);
                }
            }
            type();
        }

        // Coze API 交互函数
        async function ensureCozeConversation() {
            if (currentCozeConversationId) return currentCozeConversationId;
            console.log("正在创建新的Coze会话...");
            const reqBody = { bot_id: COZE_BOT_ID };
            try {
                const resp = await fetch(API_URL_CREATE_CONVERSATION, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${COZE_ACCESS_TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(reqBody)
                });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({ msg: `HTTP ${resp.status}` }));
                    throw new Error(`创建会话失败: ${err.msg || resp.statusText}`);
                }
                const data = await resp.json();
                if (data.code === 0 && data.data && data.data.id) {
                    currentCozeConversationId = data.data.id;
                    console.log(`新会话创建成功: ${currentCozeConversationId}`);
                    return currentCozeConversationId;
                } else {
                    throw new Error(data.msg || "创建会话API返回无效数据");
                }
            } catch (e) {
                console.error("创建会话出错:", e);
                throw e;
            }
        }

        async function sendMessageWithOptionalImage() {
            const input = document.getElementById('userInput');
            const question = input.value.trim();
            if (!question && !selectedChatImageFile) {
                alert("请输入消息或选择图片。");
                return;
            }

            let userMsgDisplay = question;
            if (selectedChatImageFile) userMsgDisplay = `[图片: ${selectedChatImageFile.name}] ${question}`;
            addMessage(userMsgDisplay, 'user');

            const loadingMsgEl = addMessage("正在处理...", 'bot');
            input.value = '';
            const imageFileToSend = selectedChatImageFile;
            window.removeChatImagePreview();

            try {
                const convId = await ensureCozeConversation();
                if (!convId) {
                    updateMessage(loadingMsgEl, "无法获取会话。", true);
                    return;
                }
                let chatUrl = API_URL_CHAT_BASE + `?conversation_id=${convId}`;
                let additionalMessages = [];
                let textForContent = question && question.trim() !== "" ? question.trim() : "请处理这张图片并描述其内容。";

                if (imageFileToSend) {
                    const maxSizeInBytes = 512 * 1024 * 1024;
                    if (imageFileToSend.size > maxSizeInBytes) {
                        updateMessage(loadingMsgEl, "图片大小超过 512 MB 限制，请选择更小的图片。", true);
                        return;
                    }

                    updateMessage(loadingMsgEl, "上传图片中...", false);
                    let fileId;
                    const formData = new FormData();
                    formData.append('file', imageFileToSend);
                    const uploadResp = await fetch(API_URL_FILE_UPLOAD, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${COZE_ACCESS_TOKEN}` },
                        body: formData
                    });

                    if (!uploadResp.ok) {
                        const err = await uploadResp.json().catch(() => ({ msg: `HTTP ${uploadResp.status}` }));
                        throw new Error(`图片上传失败: ${err.msg || uploadResp.statusText}`);
                    }
                    const uploadData = await uploadResp.json();
                    if (uploadData.code === 0 && uploadData.data && uploadData.data.id) {
                        fileId = uploadData.data.id;
                    } else {
                        throw new Error(uploadData.msg || "未获取到 File ID");
                    }
                    updateMessage(loadingMsgEl, "图片上传成功，沟通中...", false);

                    const contentArray = [
                        { type: "text", text: textForContent },
                        { type: "image", file_id: fileId }
                    ];
                    const contentString = JSON.stringify(contentArray);
                    additionalMessages = [
                        { role: "user", content: contentString, content_type: "object_string" }
                    ];
                } else {
                    additionalMessages = [
                        { role: "user", content: question, content_type: "text" }
                    ];
                }

                const chatReqBody = {
                    bot_id: COZE_BOT_ID,
                    user_id: COZE_USER_ID,
                    stream: false,
                    auto_save_history: true,
                    additional_messages: additionalMessages
                };

                console.log("Request Body:", chatReqBody);
                const chatResp = await fetch(chatUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${COZE_ACCESS_TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(chatReqBody)
                });
                if (!chatResp.ok) {
                    const err = await chatResp.json().catch(() => ({ msg: `HTTP ${chatResp.status}` }));
                    throw new Error(`对话失败: ${err.msg}`);
                }
                const chatData = await chatResp.json();
                if (chatData.code === 0 && chatData.data && chatData.data.id) {
                    await pollForChatCompletion(convId, chatData.data.id, loadingMsgEl);
                } else {
                    throw new Error(chatData.msg || "对话 API 返回无效数据");
                }
            } catch (e) {
                console.error("发送消息出错:", e);
                updateMessage(loadingMsgEl, `请求出错: ${e.message}`, true);
            }
        }

        async function pollForChatCompletion(conversationId, chatId, messageElementToUpdate) {
            const finalRetrieveChatUrl = `${API_URL_RETRIEVE_CHAT_DETAILS}?conversation_id=${conversationId}&chat_id=${chatId}`;
            const finalRetrieveMessagesUrl = `${API_URL_LIST_CONVERSATION_MESSAGES}?conversation_id=${conversationId}`;
            let attempts = 0;
            const maxAttempts = 30;
            const interval = 3000;
            updateMessage(messageElementToUpdate, "正在火速为您处理，请稍等...", false);
            const poll = async () => {
                if (attempts >= maxAttempts) {
                    updateMessage(messageElementToUpdate, "获取回复超时。", true);
                    return;
                }
                attempts++;
                console.log(`轮询 #${attempts} Chat: ${chatId}`);
                try {
                    const detailResp = await fetch(finalRetrieveChatUrl, { headers: { 'Authorization': `Bearer ${COZE_ACCESS_TOKEN}` } });
                    if (!detailResp.ok) {
                        const err = await detailResp.json().catch(() => ({ msg: `HTTP ${detailResp.status}` }));
                        throw new Error(`查详情失败: ${err.msg}`);
                    }
                    const detailData = await detailResp.json();
                    if (detailData.code === 0 && detailData.data) {
                        const status = detailData.data.status;
                        if (status === 'completed') {
                            const msgsResp = await fetch(finalRetrieveMessagesUrl, { headers: { 'Authorization': `Bearer ${COZE_ACCESS_TOKEN}` } });
                            if (!msgsResp.ok) {
                                const err = await msgsResp.json().catch(() => ({ msg: `HTTP ${msgsResp.status}` }));
                                throw new Error(`查消息失败: ${err.msg}`);
                            }
                            const msgsData = await msgsResp.json();
                            if (msgsData.code === 0 && msgsData.data && msgsData.data.length > 0) {
                                let found = false;
                                for (let i = msgsData.data.length - 1; i >= 0; i--) {
                                    const msg = msgsData.data[i];
                                    if (msg.chat_id === chatId && msg.role === 'assistant' && msg.type === 'answer') {
                                        updateMessage(messageElementToUpdate, msg.content, true);
                                        found = true;
                                        break;
                                    }
                                }
                                if (!found) updateMessage(messageElementToUpdate, "对话完成，未找到回复。", true);
                            } else {
                                updateMessage(messageElementToUpdate, `对话完成，消息列表空: ${msgsData.msg || ''}`, true);
                            }
                            return;
                        } else if (['failed', 'canceled'].includes(status)) {
                            updateMessage(messageElementToUpdate, `对话出错: ${detailData.data.last_error?.msg || status}`, true);
                            return;
                        } else if (['created', 'in_progress', 'requires_action'].includes(status)) {
                            setTimeout(poll, interval);
                        } else {
                            updateMessage(messageElementToUpdate, `未知状态: ${status}`, true);
                            return;
                        }
                    } else {
                        throw new Error(`查详情API错: ${detailData.msg}`);
                    }
                } catch (e) {
                    console.error("轮询出错:", e);
                    updateMessage(messageElementToUpdate, `获取回复出错: ${e.message}`, true);
                }
            };
            poll();
        }
        // 回车键发送和发送按钮点击处理
        const setupMessageSending = () => {
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton'); // 如果有发送按钮

            if (userInput) {
                userInput.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessageWithOptionalImage();
                    }
                });
            }

            if (sendButton) {
                sendButton.addEventListener('click', function (e) {
                    e.preventDefault();
                    sendMessageWithOptionalImage();
                });
            }
        };


        // DOMContentLoaded 事件监听器
        document.addEventListener('DOMContentLoaded', function () {
            setupMessageSending();
            const chatBox = document.getElementById('chatBox');
            const chatImageUploadInputEl = document.getElementById('chatImageUpload');
            const chatImagePreviewContainerEl = document.getElementById('chatImagePreviewContainer');
            const polishTextBtn = document.getElementById('polishTextBtn');
            const chatInput = document.getElementById('userInput');

            // 添加开场白
            if (chatBox && !chatBox.querySelector('.message.bot-opening')) {
                const openingMessage = "你好啊，不会写日记？可以给我几个关键词，我来帮你生成一篇旅游日记，我也可以根据你的草稿为你润色哦。你也可以试试上传你所拍摄的图片，我来根据图片为你生成旅游日记，但请告诉我日记相关的关键词哦，比如地点、人物、事件、心情等。";
                const openingMsgElement = addMessage('', 'bot-opening');
                if (openingMsgElement) {
                    simulateTypingEffect(openingMsgElement, openingMessage, false);
                }
            }

            // 聊天框图片上传和预览逻辑
            if (chatImageUploadInputEl && chatImagePreviewContainerEl) {
                chatImageUploadInputEl.addEventListener('change', function (event) {
                    if (event.target.files && event.target.files[0]) {
                        selectedChatImageFile = event.target.files[0];
                        chatImagePreviewContainerEl.innerHTML = `
                        <div class="preview-item">
                            <img src="${URL.createObjectURL(selectedChatImageFile)}" alt="图片预览" class="chat-preview-image">
                            <span class="remove-preview-btn" onclick="window.removeChatImagePreview()" title="移除图片">×</span>
                        </div>
                    `;
                    }
                    event.target.value = '';
                });
            }

            window.removeChatImagePreview = function () {
                selectedChatImageFile = null;
                if (chatImagePreviewContainerEl) chatImagePreviewContainerEl.innerHTML = '';
                if (chatImageUploadInputEl) chatImageUploadInputEl.value = null;
            };

            // 一键润色按钮逻辑
            if (polishTextBtn && chatInput) {
                polishTextBtn.addEventListener('click', function () {
                    if (window.editor) {
                        const editorText = window.editor.getText().trim();
                        if (editorText) {
                            chatInput.value = editorText + " 一键润色";
                            chatInput.focus();
                            chatInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else {
                            alert('请先在编辑器中输入需要润色的日记内容。');
                        }
                    } else {
                        alert('编辑器尚未初始化，请稍候再试。');
                    }
                });
            }

            // 插入到编辑器逻辑
            if (chatBox) {
                chatBox.addEventListener('click', (e) => {
                    if (e.target.classList.contains('insert-btn')) {
                        const messageEl = e.target.closest('.message.bot');
                        let messageText = messageEl?.querySelector('.bot-message')?.innerHTML ||
                            messageEl?.textContent.replace('插入到编辑器', '').trim();

                        if (!messageText) {
                            alert('无法获取 AI 回复内容，请重试。');
                            console.error('无法获取 AI 回复内容');
                            return;
                        }

                        if (window.editor) {
                            const editor = window.editor;
                            let aiResponseText = messageText;

                            try {
                                const parsed = JSON.parse(messageText);
                                if (parsed && parsed.content) {
                                    aiResponseText = parsed.content;
                                }
                            } catch (parseError) { /* 忽略解析错误 */ }

                            // 确保正确处理换行
                            let processedAiHtml = aiResponseText
                                .replace(/\n/g, '<br>')  // 替换换行符为 <br>
                                .replace(/<br><br>/g, '</p><p>')  // 双换行转换为段落分隔
                                .replace(/^/, '<p>')  // 开头添加段落
                                .replace(/$/, '</p>'); // 结尾添加段落

                            // 如果使用了 marked.js，优先使用它处理
                            if (typeof marked === 'function') {
                                try {
                                    processedAiHtml = marked.parse(aiResponseText);
                                } catch (markdownError) {
                                    console.warn("Markdown 解析失败，使用原始文本:", markdownError);
                                }
                            }

                            try {
                                editor.focus();
                                // 先插入一个空段落确保格式正确
                                editor.dangerouslyInsertHtml('<p><br></p>');
                                // 插入处理后的内容
                                editor.dangerouslyInsertHtml(processedAiHtml);
                            } catch (insertError) {
                                console.error("插入 HTML 时出错:", insertError);
                                alert("插入内容时发生错误，请重试。");
                            }
                        } else {
                            alert('编辑器尚未初始化，请刷新页面');
                        }
                    }
                });
            }

            // “媒体管理”中“用此图提问AI”按钮的事件监听器
            const mediaListElement = document.getElementById('media-list');
            if (mediaListElement) {
                mediaListElement.addEventListener('click', async function (event) {
                    const button = event.target.closest('.ask-ai-with-media-btn');
                    if (button) {
                        const mediaId = button.dataset.mediaId;
                        const mediaItemElement = document.getElementById(mediaId);
                        if (!mediaItemElement) {
                            alert("找不到对应的媒体项。");
                            return;
                        }

                        let imageFile = window.mediaFileObjects && window.mediaFileObjects[mediaId] ? window.mediaFileObjects[mediaId] : null;
                        if (!imageFile) {
                            const imgPreview = mediaItemElement.querySelector('img.media-preview');
                            if (imgPreview && imgPreview.src.startsWith('blob:')) {
                                try {
                                    const response = await fetch(imgPreview.src);
                                    const blob = await response.blob();
                                    const fileName = `media_image_blob_${Date.now()}.${blob.type.split('/')[1] || 'jpg'}`;
                                    imageFile = new File([blob], fileName, { type: blob.type });
                                    if (window.mediaFileObjects) window.mediaFileObjects[mediaId] = imageFile;
                                } catch (e) {
                                    alert("无法从媒体预览中获取图片数据。请尝试重新在媒体管理中添加该图片。");
                                    console.error("媒体管理Blob恢复失败:", e);
                                    return;
                                }
                            } else {
                                alert("在媒体管理中找不到原始图片文件数据。请尝试重新添加。");
                                console.error("媒体管理：无File对象且预览非Blob for mediaId:", mediaId);
                                return;
                            }
                        }

                        if (!imageFile) {
                            alert("最终无法获取媒体管理中的图片文件。");
                            return;
                        }

                        const imageCaptionInput = mediaItemElement.querySelector('.media-caption');
                        const imageCaption = imageCaptionInput ? imageCaptionInput.value.trim() : "";
                        const userInputChat = document.getElementById('userInput').value.trim();
                        let textPrompt = userInputChat || imageCaption || "请描述这张图片并基于它写一篇相关的旅游日记片段。";

                        if (!userInputChat && imageCaption) {
                            textPrompt = `关于这张图片（描述：${imageCaption}），请写一篇旅游日记。`;
                        } else if (!userInputChat && !imageCaption) {
                            const userProvidedPrompt = prompt("请输入关于这张图片的提问或日记主题：", "请描述这张图片，并写一篇相关的日记。");
                            if (userProvidedPrompt === null || userProvidedPrompt.trim() === "") {
                                alert("操作已取消，需要输入提示信息。");
                                return;
                            }
                            textPrompt = userProvidedPrompt.trim();
                        }

                        if (userInputChat) {
                            document.getElementById('userInput').value = '';
                        }

                        addMessage(`[使用媒体图片: ${imageFile.name}] ${textPrompt}`, 'user');
                        const loadingMsgElement = addMessage("正在处理图片并与智能体沟通...", 'bot');

                        button.disabled = true;
                        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中';

                        try {
                            await sendImageAndTextToCoze(textPrompt, imageFile, loadingMsgElement);
                        } catch (error) {
                            console.error("顶层捕获 sendImageAndTextToCoze (来自媒体管理) 错误:", error);
                        } finally {
                            button.disabled = false;
                            button.innerHTML = '<i class="fas fa-robot"></i> 用此图提问AI';
                        }
                    }
                });
            }
        });

        async function sendImageAndTextToCoze(textPrompt, imageFile, loadingMsgElement) {
            try {
                const convId = await ensureCozeConversation();
                if (!convId) {
                    updateMessage(loadingMsgElement, "无法获取会话。", true);
                    return;
                }

                let fileId;
                const formData = new FormData();
                formData.append('file', imageFile);
                const uploadResp = await fetch(API_URL_FILE_UPLOAD, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${COZE_ACCESS_TOKEN}` },
                    body: formData
                });

                if (!uploadResp.ok) {
                    const err = await uploadResp.json().catch(() => ({ msg: `HTTP ${uploadResp.status}` }));
                    throw new Error(`图片上传失败: ${err.msg || uploadResp.statusText}`);
                }
                const uploadData = await uploadResp.json();
                if (uploadData.code === 0 && uploadData.data && uploadData.data.id) {
                    fileId = uploadData.data.id;
                } else {
                    throw new Error(uploadData.msg || "未获取到 File ID");
                }

                const contentArray = [
                    { type: "text", text: textPrompt },
                    { type: "image", file_id: fileId }
                ];
                const contentString = JSON.stringify(contentArray);
                const chatReqBody = {
                    bot_id: COZE_BOT_ID,
                    user_id: COZE_USER_ID,
                    stream: false,
                    auto_save_history: true,
                    additional_messages: [
                        { role: "user", content: contentString, content_type: "object_string" }
                    ]
                };

                const chatResp = await fetch(`${API_URL_CHAT_BASE}?conversation_id=${convId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${COZE_ACCESS_TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(chatReqBody)
                });

                if (!chatResp.ok) {
                    const err = await chatResp.json().catch(() => ({ msg: `HTTP ${chatResp.status}` }));
                    throw new Error(`对话失败: ${err.msg}`);
                }
                const chatData = await chatResp.json();
                if (chatData.code === 0 && chatData.data && chatData.data.id) {
                    await pollForChatCompletion(convId, chatData.data.id, loadingMsgElement);
                } else {
                    throw new Error(chatData.msg || "对话 API 返回无效数据");
                }
            } catch (e) {
                console.error("发送图片和文本到 Coze 出错:", e);
                updateMessage(loadingMsgElement, `请求出错: ${e.message}`, true);
            }
        }
    </script>

</body>

</html>